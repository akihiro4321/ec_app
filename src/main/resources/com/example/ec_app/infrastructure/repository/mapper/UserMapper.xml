<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.ec_app.infrastructure.repository.mapper.UserMapper">
  <resultMap id="LoginUserMap" type="com.example.ec_app.entity.UserDto">
    <id property="userId" column="user_id"/>
    <result property="email" column="email"/>
    <result property="password" column="password"/>
    <result property="firstName" column="first_name"/>
    <result property="lastName" column="last_name"/>
    <result property="disabled" column="disabled"/>
    <collection property="roleList" ofType="java.lang.String" javaType="list">
      <result column="role_name"/>
    </collection>
  </resultMap>

  <select id="findByEmail" resultMap="LoginUserMap">
    SELECT
      u.USER_ID,
      u.EMAIL,
      u.PASSWORD,
      u.FIRST_NAME,
      u.LAST_NAME,
      u.DISABLED,
      r.ROLE_NAME
    FROM USERS AS u
      INNER JOIN USER_ROLE AS ur
        ON u.USER_ID = ur.USER_ID
      INNER JOIN ROLES AS r
        ON ur.ROLE_ID = r.ROLE_ID
    WHERE u.EMAIL = #{email}
  </select>

  <insert id="saveUser" useGeneratedKeys="true" keyColumn="user_id" keyProperty="userId">
    INSERT INTO
      USERS (EMAIL, PASSWORD, FIRST_NAME, LAST_NAME)
    VALUES
      (#{email}, #{password}, #{firstName}, #{lastName})
  </insert>
  
  <insert id="saveRoles">
    INSERT INTO
      USER_ROLE (USER_ID, ROLE_ID)
    SELECT #{userId}, ROLE_ID
    FROM ROLES AS r
    WHERE r.ROLE_NAME IN
      <foreach item="item" index="index" collection="roleList"
      open="(" separator="," close=")">
        #{item}
      </foreach>
  </insert>

</mapper>